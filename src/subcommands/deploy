#!/usr/bin/env bash

set -eo pipefail; [[ $DEBUG ]] && set -x

deploy() {
  declare cmd="deploy"
  [[ "$1" == "$cmd" ]] && shift 1

  REPO_PATH=$1
  REPO_NAME=$(basename $REPO_PATH)
  DEPLOYER_IMAGE=$SWARMLET_REGISTRY/v2/deployer:latest

  if [[ "$REPO_NAME" == "deployer" ]]; then
    DEPLOYER_IMAGE=swarmlet/deployer:test
  fi

  # --config $SWARMLET_CONFIG
  docker run --rm \
    --network $SWARMLET_NETWORK_NAME \
    -v $REPO_PATH:$REPO_PATH \
    -v $DOCKER_SOCKET:$DOCKER_SOCKET \
    -v $SWARMLET_CONFIG:$SWARMLET_CONFIG:ro \
    $DEPLOYER_IMAGE deploy $REPO_PATH
}

"$@"
