#!/usr/bin/env bash

set -eo pipefail; [[ $DEBUG ]] && set -x

is-stack-healthy() {
  SERVICE="$1"
  REPLICAS=$(docker stack services $SERVICE --format='{{.Replicas}}')

  if [[ $(echo $REPLICAS | sed 's/\/[0-9]//') -gt 0 ]];
    then return 0
    else return 1
  fi
}

deploy() {
  declare cmd="deploy"
  [[ "$1" == "$cmd" ]] && shift 1

  REPO_PATH=$1

  # Wait for deployer to start
  while ! is-stack-healthy deployer; do sleep 1; done
  DEPLOYER_AGENT=$(docker ps --filter name=deployer_agent -q)

  docker container exec $DEPLOYER_AGENT /entrypoint deploy $REPO_PATH
}

"$@"
