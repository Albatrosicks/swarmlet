#!/usr/bin/env bash

set -eo pipefail; [[ $DEBUG ]] && set -x

deploy() {
  declare cmd="deploy"
  [[ "$1" == "$cmd" ]] && shift 1

  REPO_DEST=$1

  printenv
  echo $REPO_DEST

  echo -e " \
  docker run --rm \n \
    # --config $SWARMLET_CONFIG \
    -v $REPO_DEST:$REPO_DEST \n \
    -v $DOCKER_SOCKET:$DOCKER_SOCKET \n \
    -v $SWARMLET_CONFIG:$SWARMLET_CONFIG:ro \n \
    $SWARMLET_REGISTRY/deployer \n \
    deploy $REPO_DEST || exit 1 \
  "

  docker run --rm \
    # --config $SWARMLET_CONFIG
    -v $REPO_DEST:$REPO_DEST \
    -v $DOCKER_SOCKET:$DOCKER_SOCKET \
    -v $SWARMLET_CONFIG:$SWARMLET_CONFIG:ro \
    $SWARMLET_REGISTRY/deployer \
    deploy $REPO_DEST || exit 1
}

"$@"
